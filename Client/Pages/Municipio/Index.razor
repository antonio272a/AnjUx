@attribute [HubIcon(Icon.City, "Municípios")]
@inject MunicipioService municipioService
@inject CoreNavBarStore navBarStore
@inject CoreNotificationService notificationService

<CoreCard>
    <CoreDataGrid Data="@Municipios">
        <HeaderTemplate>
            <CoreForm Model="@Model">
                <CoreRow>
                    <EditorFor Property="(model) => model.Nome" />
                </CoreRow>
                <CoreRow Actions>
                    <CoreButton Icon="Icon.Search" ToolTip="Buscar" Click="async () => await BuscarMunicipios()" />
                </CoreRow>
            </CoreForm>
        </HeaderTemplate>
        <Columns>
            <CoreDataGridColumn Property="(model) => model.CodigoIBGE" />
            <CoreDataGridColumn Property="(model) => model.Nome" />
            <CoreDataGridColumn Property="(model) => model.UF" />
            <CoreDataGridColumn ActionColumn>
                <Template Context="data">
                    <CoreButton ToolTip="Buscar Informações" Icon="Icon.Search" Click="async () => await BuscarInformacoes(data)" />
                </Template>
            </CoreDataGridColumn>
        </Columns>
    </CoreDataGrid>
</CoreCard>

@code {
    private SearchModel Model = new();

    private List<Municipio> Municipios { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        await GetMunicipios();

        navBarStore.Titulo = "Municípios";

        navBarStore.SetItens(new CoreNavBarItem(Icon.Sync, async () => await municipioService.AtualizarMunicipios(), "Atualizar Municípios"));

        await base.OnInitializedAsync();
    }

    private async Task GetMunicipios()
    {
        Municipios = await municipioService.Listar() ?? [];
    }

    private async Task BuscarMunicipios()
    {
        Municipios = await municipioService.Buscar(Model.Nome) ?? [];
    }

    private async Task BuscarInformacoes(Municipio municipio)
    {
        if (await municipioService.BuscarInformacoes(municipio.ID))
            notificationService.Notify(NotificacaoTipo.Sucesso, "Informações buscadas com sucesso!");
    }

    private class SearchModel
    {
        public string? Nome { get; set; }
    }
}
